// This file was generated from `./pkg/cmd/generate/generate_message_handler.go`.

package net

import (
	"errors"
	"fmt"

	"github.com/golang/protobuf/proto"
	"github.com/hueypark/marsettler/pkg/message"
)

// Handler is message handler.
type Handler struct {
{{ with .Messages }}{{ range . }}	{{ .Handler }} func(*Conn, *message.{{ .Message }}) error
{{ end }}{{ end }}}

// HandlerFuncs represents handler functions.
type HandlerFuncs map[message.ID]interface{}

// NewHandler creates new handler.
func NewHandler(handlers HandlerFuncs) (*Handler, error) {
	h := &Handler{}

	for id, handler := range handlers {
		switch id {
		{{ with .Messages }}{{ range . }}case message.{{ .Message }}ID:
			v, ok := handler.(func(*Conn, *message.{{ .Message }}) error)
			if !ok {
				return nil, errors.New("handler does not handles {{ .Message }}")
			}

			h.{{ .Handler }} = v
		{{ end }}{{ end }}}
	}

	return h, nil
}

// Handle handles message.
func (h *Handler) Handle(conn *Conn, id message.ID, bytes []byte) error {
	switch id {
	{{ with .Messages }}{{ range . }}case message.{{ .Message }}ID:
		m := &message.{{ .Message }}{}
		err := proto.Unmarshal(bytes, m)
		if err != nil {
			return err
		}

		if h.{{ .Handler }} == nil {
			return nil
		}

		return h.{{ .Handler }}(conn, m)
	{{ end }}{{ end }}}

	return errors.New(fmt.Sprintf("unhandled id: %v", id))
}
